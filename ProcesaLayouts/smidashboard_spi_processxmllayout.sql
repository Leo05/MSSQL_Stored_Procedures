-- =============================================
-- AUTHOR     : LEONEL GONZALEZ
-- DATE       :
-- DESCRIPTION: PROCESS ELECTRONIC INVOICE AND CREATE RECORDS IN TRAFIC SYSTEM
-- =============================================
USE [Aduana]
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'smidashboard_spi_processxmllayout' AND TYPE = 'P')
	  DROP PROCEDURE smidashboard_spi_processxmllayout;
GO
CREATE PROCEDURE smidashboard_spi_processxmllayout(@REF VARCHAR(10), @XMLFILEPATH VARCHAR(MAX))
WITH ENCRYPTION
AS
BEGIN

BEGIN TRY
	BEGIN TRANSACTION

	ALTER TABLE tblclasifica DISABLE TRIGGER lock_tblclasifica
	ALTER TABLE tblfactgen DISABLE TRIGGER aviso_ctestblfactgen

		DECLARE @FULLXMLVAR VARCHAR(MAX)
		DECLARE @sql NVARCHAR(max)='select @Result=(SELECT * 
									FROM (SELECT CONVERT(varchar(max), BulkColumn) FROM OPENROWSET(BULK '''+@XMLFILEPATH+''', SINGLE_BLOB) AS x)  T(c))';	

		EXEC sp_executesql @sql, N'@Result varchar(max) out', @FULLXMLVAR out

		DECLARE @CLIENTE_ID INT, @PROVEEDOR_ID INT, @PREF VARCHAR(8), @TIPOOP BIT
	
		IF NOT EXISTS(SELECT TRAREFERENCIA FROM TRAFICO WHERE TRAREFERENCIA=@REF) BEGIN
			RAISERROR ('LA REFERENCIA NO EXISTE', 16, 1); 
		END
		ELSE BEGIN
			SELECT @CLIENTE_ID=TRACLI, @PROVEEDOR_ID=TRAPROCLI, @PREF=PREF, @TIPOOP=TRAIMPEXP FROM TRAFICO WHERE TRAREFERENCIA=@REF
		END
	
	
		DECLARE @FULLXML XML
		SET @FULLXML=@FULLXMLVAR;
	
		DECLARE @CONCEPTOS TABLE(
		 ID INT IDENTITY(1,1),FACTURA VARCHAR(50),FECHA DATETIME,PAISFAC VARCHAR(3),MV INT
		,VIN INT,VALOR_FACTURA FLOAT,MONEDA VARCHAR(3),RENGLON INT,PARTE VARCHAR(30),FRACCION VARCHAR(8),GRUPO VARCHAR (10),DESC_INGLES VARCHAR(250)
		,DESC_ESPANOL VARCHAR(250),ORIGEN VARCHAR(3),TLC VARCHAR(1),PROSEC VARCHAR(1),MA VARCHAR(1),UMFO VARCHAR(3),CANTIDAD_UMFO FLOAT,UMC VARCHAR(3)	
		,CANTIDAD_UMC FLOAT	,CANTIDAD_UMT FLOAT,PESO_LBS FLOAT,PESO_KGS FLOAT,PRECIO_UNITARIO FLOAT,TOTAL FLOAT,FACTURA_ID NUMERIC(10),PARTIDA_ID NUMERIC(10),CLASIFICADA BIT, UMT VARCHAR(3),IVA FLOAT, IGI FLOAT)

		INSERT INTO @CONCEPTOS(FACTURA,FECHA,PAISFAC,MV,VIN,VALOR_FACTURA,MONEDA,RENGLON,PARTE,FRACCION,GRUPO,DESC_INGLES,DESC_ESPANOL,ORIGEN,TLC,PROSEC,MA,UMFO,CANTIDAD_UMFO,UMC,CANTIDAD_UMC,
							   CANTIDAD_UMT,PESO_LBS,PESO_KGS,PRECIO_UNITARIO,TOTAL)
		SELECT 
			 T.c.value('F1[1]','varchar(50)')
			,T.c.value('F2[1]','varchar(15)')
			,T.c.value('F3[1]','varchar(3)')
			,T.c.value('F4[1]','int')
			,T.c.value('F5[1]','int')
			,T.c.value('F6[1]','float')
			,T.c.value('F7[1]','varchar(3)')
			,T.c.value('F8[1]','int')
			,T.c.value('F9[1]','varchar(30)')
			,T.c.value('F10[1]','varchar(8)')
			,T.c.value('F11[1]','varchar(10)')
			,T.c.value('F12[1]','varchar(250)')
			,T.c.value('F13[1]','varchar(250)')
			,T.c.value('F14[1]','varchar(3)')
			,T.c.value('F15[1]','varchar(1)')
			,T.c.value('F16[1]','varchar(1)')
			,T.c.value('F17[1]','varchar(1)')
			,T.c.value('F18[1]','varchar(3)')
			,T.c.value('F19[1]','float')
			,T.c.value('F20[1]','varchar(3)')
			,T.c.value('F21[1]','float')
			,T.c.value('F22[1]','float')
			,T.c.value('F23[1]','float')
			,T.c.value('F24[1]','float')
			,T.c.value('F25[1]','float')
			,T.c.value('F26[1]','float')
		FROM   @FULLXML.nodes('/NewDataSet/Table') T(c)
		ORDER BY T.c.value('F1[1]','varchar(50)')

		IF (SELECT COUNT(*) FROM @CONCEPTOS)=0 BEGIN
			RAISERROR ('LA NO SE ENCONTRO INFORMACION EN EL ARCHIVO O LAYOUT INVALIDO', 16, 1); 
		END		
		------------------------------------------------------
		    DELETE FROM @CONCEPTOS WHERE ISNULL(FACTURA,'')=''
		------------------------------------------------------
		DECLARE @FACTURAS TABLE(
			 ID INT IDENTITY(1,1),FACTURA_ID NUMERIC(10),FACGNOFAC VARCHAR(50),FACGREF VARCHAR(10),FACGFEFAC DATETIME,FACGVALOR FLOAT,FACGMONEDA VARCHAR(3)
			,FACGPAIS VARCHAR(3),FACGPROV INT,FACGCLI INT,FACGVALORMERC FLOAT,FACGSUBDIVISION INT,FACGUSUARIO INT,PREF VARCHAR(8),FACGBANDERA BIT
			,FACGCLASIFICADA BIT,FACGSUCURSAL INT,NOMOSTRARENINVENTARIO BIT,VIN VARCHAR(1),FACGINCOTERM VARCHAR(3),SMIFACCFDI BIT,SMIFACELECTRONICA BIT)

		INSERT INTO @FACTURAS(FACTURA_ID,FACGNOFAC,FACGREF,FACGFEFAC,FACGVALOR,FACGMONEDA,FACGPAIS ,FACGPROV ,FACGCLI ,FACGVALORMERC ,FACGSUBDIVISION ,FACGUSUARIO ,
							  PREF,FACGBANDERA ,FACGCLASIFICADA ,FACGSUCURSAL ,NOMOSTRARENINVENTARIO ,VIN ,FACGINCOTERM ,SMIFACCFDI ,SMIFACELECTRONICA)
		SELECT 0,ISNULL(FACTURA,GETDATE()),@REF,FECHA,0,MONEDA,PAISFAC,@PROVEEDOR_ID,@CLIENTE_ID,0,0,0,@PREF,0,1,0,0,0,'',0,1 
		FROM @CONCEPTOS 
		GROUP BY FACTURA,FECHA,MONEDA,PAISFAC
		ORDER BY FACTURA
	
		DECLARE @x INT=1, @TOTALFACTURAS INT = (SELECT COUNT(*) FROM @FACTURAS)
		DECLARE @FACTURA_ID NUMERIC(10),@FACTURA VARCHAR(50),@TOTALFACTURA FLOAT;

		------------------------------------------------------
			DELETE FROM TBLFACTGEN WHERE FACGREF=@REF AND PREF=@PREF;
		------------------------------------------------------

		WHILE @x<=@TOTALFACTURAS BEGIN
			
			SET @TOTALFACTURA=(SELECT SUM(VALOR_FACTURA) FROM @CONCEPTOS WHERE FACTURA=(SELECT FACGNOFAC FROM @FACTURAS WHERE ID=@x))
			
			INSERT INTO TBLFACTGEN(FACGFEFAC,FACGNOFAC,FACGREF,FACGVALOR,FACGMONEDA,FACGPAIS ,FACGPROV ,FACGCLI ,FACGVALORMERC ,FACGSUBDIVISION ,FACGUSUARIO ,
							  PREF,FACGBANDERA ,FACGCLASIFICADA ,FACGSUCURSAL ,NOMOSTRARENINVENTARIO ,VIN ,FACGINCOTERM ,SMIFACCFDI ,SMIFACELECTRONICA)
			SELECT ISNULL(FACGFEFAC,GETDATE()),FACGNOFAC,FACGREF,@TOTALFACTURA,FACGMONEDA,FACGPAIS ,FACGPROV ,FACGCLI ,@TOTALFACTURA ,FACGSUBDIVISION ,FACGUSUARIO ,
					PREF,FACGBANDERA ,FACGCLASIFICADA ,FACGSUCURSAL ,NOMOSTRARENINVENTARIO ,VIN ,FACGINCOTERM ,SMIFACCFDI ,SMIFACELECTRONICA
			FROM @FACTURAS WHERE ID=@x;

			SET @FACTURA_ID=@@IDENTITY;			
			UPDATE @FACTURAS SET FACTURA_ID=FACTURA_ID WHERE ID=@x;
			
			SELECT @FACTURA=FACGNOFAC FROM @FACTURAS WHERE ID=@x;	
			UPDATE @CONCEPTOS SET FACTURA_ID=@FACTURA_ID WHERE FACTURA=@FACTURA;
			
			SET @x=@x+1;
		END

		------------------------------------------------------
			DELETE FROM TBLCLASIFICA WHERE REFERENCIA=@REF;
		------------------------------------------------------

		DECLARE @PARTNUM VARCHAR(100)
		DECLARE @I INT=(SELECT COUNT(*) FROM @CONCEPTOS)
		SET @x=1
		WHILE @x<=@I BEGIN
			
			INSERT INTO TBLCLASIFICA(FACTURA_ID,FACTURA,REFERENCIA,RENGLON,NUMPARTE,DESCFRA,CANTIDAD,CANTFAC,CANTTAR,PESOLBS,PESOKGS
									,PREUNITARIO,TOTAL,CC,VPR,USUARIO,NUMFRACCION,FECHA,ULTIMA_MOD,PAISORIGEN,UNIMEDFAC
									,UA,TLC,PROSEC,MA,INDUSTRIA,CLAVE1) 
			SELECT FACTURA_ID,FACTURA,@REF,RENGLON,PARTE,DESC_ESPANOL,CANTIDAD_UMFO,CANTIDAD_UMC,CANTIDAD_UMT,PESO_KGS/0.4536,PESO_KGS
				,TOTAL/CANTIDAD_UMFO,TOTAL,0,0,1,FRACCION,GETDATE(),GETDATE(),ORIGEN,UMC,UMFO,TLC,PROSEC,'N','',GRUPO 
			FROM @CONCEPTOS WHERE ID=@x;

			SET @FACTURA_ID=(SELECT FACTURA_ID FROM @CONCEPTOS WHERE ID=@x);
			SET @PARTNUM=(SELECT PARTE FROM @CONCEPTOS WHERE ID=@x);

			IF EXISTS(SELECT PARTNUM FROM TBLPARTES WHERE PARTNUM=@PARTNUM AND PARTCLI=@CLIENTE_ID) BEGIN
				UPDATE TBLCLASIFICA SET 
				 NUMFRACCION=TBLPARTES.PARTFRAMEX
				,PAISORIGEN=TBLPARTES.PARTPAIS
				,UA=TBLPARTES.PARTMEDIDA
				,UNIMEDFAC=TBLPARTES.PARTMEDIDA
				,DESCFRA=TBLPARTES.PARTDESCESP
				,TLC=TBLPARTES.PARTTLC
				,PROSEC=TBLPARTES.PROSEC
				FROM TBLCLASIFICA
				LEFT JOIN TBLPARTES ON PARTCLI=@CLIENTE_ID AND TBLPARTES.PARTNUM=TBLCLASIFICA.NUMPARTE
				WHERE FACTURA_ID=@FACTURA_ID;

				UPDATE @CONCEPTOS SET CLASIFICADA=1 WHERE ID=@x;
			END
			ELSE BEGIN
				UPDATE @CONCEPTOS SET CLASIFICADA=0 WHERE ID=@x;
			END

			UPDATE TBLCLASIFICA SET UMFAC=TBLUDC.CLAVE
			FROM TBLCLASIFICA
			LEFT JOIN TBLUDC ON TBLUDC.ABREVIACION=TBLCLASIFICA.UA
			WHERE FACTURA_ID=@FACTURA_ID;

			UPDATE TBLCLASIFICA SET UMUMF=TBLUNIDAD.CLAVE
			FROM TBLCLASIFICA
			LEFT JOIN TBLUNIDAD ON TBLUNIDAD.ABREVIACION=TBLCLASIFICA.UNIMEDFAC
			WHERE FACTURA_ID=@FACTURA_ID;
			
			IF @TIPOOP=0 BEGIN
				UPDATE TBLCLASIFICA SET 
				 IVA=0.00,
				 UNIMEDTAR=(CASE WHEN UPPER(UNID_TRF)='L' THEN 'LTR'
							  WHEN UPPER(UNID_TRF)='M²' THEN 'M2'
							  ELSE UPPER(UNID_TRF)END),
				 ADV=0
				 FROM TBLCLASIFICA 
				 LEFT JOIN EXPORTA ON EXPORTA.FRACCION=TBLCLASIFICA.NUMFRACCION
				 WHERE FACTURA_ID=@FACTURA_ID;

			END
			ELSE BEGIN
				UPDATE TBLCLASIFICA SET 
				 IVA=CASE WHEN PGA_IVA = 'N' THEN 0.00
						  WHEN ISNULL(PGA_IVA,'X') = 'X' THEN ISNULL((SELECT TOP 1 IVAEUA FROM TBLCOMP WHERE PREF = @PREF),0.00)
					 END,
				 UNIMEDTAR=(CASE WHEN UPPER(UNID_TRF)='L' THEN 'LTR'
							  WHEN UPPER(UNID_TRF)='M²' THEN 'M2'
							  ELSE UPPER(UNID_TRF)END),
				 ADV=0
				 FROM TBLCLASIFICA 
				 LEFT JOIN IMPORTA ON IMPORTA.FRACCION=TBLCLASIFICA.NUMFRACCION
				 WHERE FACTURA_ID=@FACTURA_ID;
			END

			UPDATE TBLCLASIFICA SET CANTTAR=PESOKGS
			FROM TBLCLASIFICA
			WHERE FACTURA_ID=@FACTURA_ID AND UNIMEDTAR='KG';

			SET @x +=1;
		END

    ALTER TABLE tblclasifica DISABLE TRIGGER lock_tblclasifica
	ALTER TABLE tblfactgen DISABLE TRIGGER aviso_ctestblfactgen	
	
	SELECT * FROM @CONCEPTOS   
	COMMIT TRANSACTION

END TRY
BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000)=ERROR_MESSAGE();
    DECLARE @ErrorSeverity INT=ERROR_SEVERITY();
    DECLARE @ErrorState INT=ERROR_STATE();

    ALTER TABLE tblclasifica DISABLE TRIGGER lock_tblclasifica
	ALTER TABLE tblfactgen DISABLE TRIGGER aviso_ctestblfactgen

    ROLLBACK TRANSACTION

    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

END CATCH	
	
			    
END
GO
GRANT EXEC ON smidashboard_spi_processxmllayout TO PUBLIC;
GO
